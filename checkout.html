<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±ÙˆØ³ÙŠ â€” Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Tajawal:wght@700;800&display=swap" rel="stylesheet"/>
  <script src="../js/supabase.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #09090a; --surface: #111210; --card: #161713; --border: #2a2c20;
      --olive: #a8b845; --olive2: #8fa034; --text: #edeee0; --muted: #6b6e50; --muted2: #9a9e7a;
      --red: #ff5555; --green: #4ade80;
    }
    body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    header {
      background: rgba(9,9,10,0.9); backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: 16px 40px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .logo-wrap { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo-icon { width: 38px; height: 38px; background: var(--olive); border-radius: 9px; display: grid; place-items: center; font-size: 18px; }
    .logo-name { font-family: 'Tajawal', sans-serif; font-size: 18px; font-weight: 800; color: var(--text); }
    .steps { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .step { display: flex; align-items: center; gap: 6px; color: var(--muted2); }
    .step.active { color: var(--olive); font-weight: 700; }
    .step.done { color: var(--green); }
    .step-dot { width: 22px; height: 22px; border-radius: 50%; background: var(--surface); border: 1px solid var(--border); display: grid; place-items: center; font-size: 10px; font-weight: 800; }
    .step.active .step-dot { background: var(--olive); border-color: var(--olive); color: #09090a; }
    .step.done .step-dot { background: var(--green); border-color: var(--green); color: #09090a; }
    .step-sep { color: var(--muted); }

    .checkout-wrap {
      max-width: 1100px; margin: 0 auto;
      padding: 40px 24px;
      display: grid; grid-template-columns: 1fr 380px; gap: 28px;
    }

    .form-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
    }
    .form-section { padding: 28px; border-bottom: 1px solid var(--border); }
    .form-section:last-child { border-bottom: none; }
    .section-title {
      font-family: 'Tajawal', sans-serif;
      font-size: 18px; font-weight: 800;
      margin-bottom: 20px;
      display: flex; align-items: center; gap: 10px;
    }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: span 2; }
    .form-label { font-size: 12px; font-weight: 700; color: var(--muted2); }
    .form-input {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 16px;
      font-size: 14px; color: var(--text);
      font-family: 'Cairo', sans-serif; outline: none;
      transition: border-color 0.2s; text-align: right;
    }
    .form-input:focus { border-color: var(--olive); }
    .form-input.error { border-color: var(--red); }
    select.form-input { cursor: pointer; }
    .error-msg { font-size: 11px; color: var(--red); margin-top: 4px; }

    /* Payment methods */
    .payment-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .pay-option {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pay-option:hover { border-color: rgba(168,184,69,0.4); }
    .pay-option.selected { border-color: var(--olive); background: rgba(168,184,69,0.08); }
    .pay-option input { display: none; }
    .pay-icon { font-size: 24px; margin-bottom: 6px; display: block; }
    .pay-name { font-size: 12px; font-weight: 700; }
    .pay-desc { font-size: 10px; color: var(--muted2); margin-top: 2px; }

    /* Order summary */
    .summary-card {
      position: sticky; top: 20px;
    }
    .summary-inner {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
    }
    .summary-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      font-family: 'Tajawal', sans-serif;
      font-size: 18px; font-weight: 800;
    }
    .summary-items { padding: 16px 24px; max-height: 280px; overflow-y: auto; }
    .summary-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 0; border-bottom: 1px solid rgba(42,44,32,0.4);
    }
    .summary-item:last-child { border-bottom: none; }
    .s-emoji { width: 44px; height: 44px; background: var(--surface); border-radius: 8px; display: grid; place-items: center; font-size: 22px; flex-shrink: 0; }
    .s-name { font-size: 13px; font-weight: 700; flex: 1; }
    .s-qty { font-size: 11px; color: var(--muted2); }
    .s-price { font-size: 14px; font-weight: 800; color: var(--olive); flex-shrink: 0; }
    .summary-totals { padding: 16px 24px; border-top: 1px solid var(--border); }
    .total-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 14px; color: var(--muted2); }
    .total-row.big { font-family: 'Tajawal', sans-serif; font-size: 20px; font-weight: 800; color: var(--text); padding-top: 12px; border-top: 1px solid var(--border); margin-top: 4px; }
    .total-row.big span:last-child { color: var(--olive); }

    .coupon-wrap { padding: 0 24px 16px; display: flex; gap: 8px; }
    .coupon-input {
      flex: 1; background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 14px; color: var(--text);
      font-family: 'Cairo', sans-serif; font-size: 13px; outline: none;
      transition: border-color 0.2s; text-align: right;
    }
    .coupon-input:focus { border-color: var(--olive); }

    .submit-btn {
      width: 100%; margin: 0 24px 24px;
      width: calc(100% - 48px);
      background: var(--olive); color: #09090a;
      border: none; border-radius: 12px;
      padding: 16px; font-size: 16px; font-weight: 800;
      font-family: 'Cairo', sans-serif;
      cursor: pointer; transition: all 0.25s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .submit-btn:hover { background: var(--olive2); transform: translateY(-1px); box-shadow: 0 10px 30px rgba(168,184,69,0.3); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .trust-badges {
      display: flex; gap: 12px; justify-content: center;
      padding: 0 24px 24px;
    }
    .trust-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--muted2); }

    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 999;
      align-items: center; justify-content: center;
      flex-direction: column; gap: 16px;
    }
    .loading-overlay.show { display: flex; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--olive); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .checkout-wrap { grid-template-columns: 1fr; }
      header { padding: 14px 16px; }
      .steps { display: none; }
      .payment-options { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<header>
  <a class="logo-wrap" href="../index.html">
    <div class="logo-icon">ğŸ‡·ğŸ‡º</div>
    <div class="logo-name">Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±ÙˆØ³ÙŠ</div>
  </a>
  <div class="steps">
    <div class="step done"><div class="step-dot">âœ“</div> Ø§Ù„Ø³Ù„Ø©</div>
    <div class="step-sep">â†</div>
    <div class="step active"><div class="step-dot">2</div> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†</div>
    <div class="step-sep">â†</div>
    <div class="step"><div class="step-dot">3</div> Ø§Ù„Ø¯ÙØ¹</div>
  </div>
</header>

<div class="checkout-wrap">
  <!-- FORM -->
  <div class="form-card">
    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
    <div class="form-section">
      <div class="section-title">ğŸ“¦ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†</div>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
          <input class="form-input" id="f_name" placeholder="Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ"/>
        </div>
        <div class="form-group">
          <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ / ÙˆØ§ØªØ³Ø§Ø¨ *</label>
          <input class="form-input" id="f_phone" placeholder="05xxxxxxxx" type="tel"/>
        </div>
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input class="form-input" id="f_email" placeholder="example@email.com" type="email"/>
        </div>
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ø¯ÙˆÙ„Ø© *</label>
          <select class="form-input" id="f_country" onchange="updateShipping()">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©</option>
            <option value="SA" data-shipping="0">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</option>
            <option value="AE" data-shipping="35">ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</option>
            <option value="KW" data-shipping="40">ğŸ‡°ğŸ‡¼ Ø§Ù„ÙƒÙˆÙŠØª</option>
            <option value="QA" data-shipping="40">ğŸ‡¶ğŸ‡¦ Ù‚Ø·Ø±</option>
            <option value="BH" data-shipping="40">ğŸ‡§ğŸ‡­ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</option>
            <option value="OM" data-shipping="45">ğŸ‡´ğŸ‡² Ø¹ÙÙ…Ø§Ù†</option>
            <option value="EG" data-shipping="50">ğŸ‡ªğŸ‡¬ Ù…ØµØ±</option>
            <option value="JO" data-shipping="50">ğŸ‡¯ğŸ‡´ Ø§Ù„Ø£Ø±Ø¯Ù†</option>
          </select>
        </div>
        <div class="form-group" id="cityGroup">
          <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© *</label>
          <select class="form-input" id="f_city_sa">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
            <option>Ø§Ù„Ø±ÙŠØ§Ø¶</option><option>Ø¬Ø¯Ø©</option><option>Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©</option>
            <option>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option><option>Ø§Ù„Ø¯Ù…Ø§Ù…</option><option>Ø§Ù„Ø®Ø¨Ø±</option>
            <option>Ø§Ù„Ø·Ø§Ø¦Ù</option><option>ØªØ¨ÙˆÙƒ</option><option>Ø£Ø¨Ù‡Ø§</option><option>Ø£Ø®Ø±Ù‰</option>
          </select>
          <input class="form-input" id="f_city_other" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" style="display:none;margin-top:8px"/>
        </div>
        <div class="form-group full">
          <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ *</label>
          <input class="form-input" id="f_address" placeholder="Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰..."/>
        </div>
        <div class="form-group full">
          <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input class="form-input" id="f_notes" placeholder="Ø£ÙŠ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ© Ù„Ù„ØªÙˆØµÙŠÙ„..."/>
        </div>
      </div>
    </div>

    <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ -->
    <div class="form-section">
      <div class="section-title">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
      <div class="payment-options">
        <label class="pay-option selected" onclick="selectPay(this, 'myfatoorah')">
          <input type="radio" name="pay" value="myfatoorah" checked/>
          <span class="pay-icon">ğŸ’³</span>
          <div class="pay-name">Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†ÙƒÙŠØ©</div>
          <div class="pay-desc">ÙÙŠØ²Ø§ / Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯</div>
        </label>
        <label class="pay-option" onclick="selectPay(this, 'mada')">
          <input type="radio" name="pay" value="mada"/>
          <span class="pay-icon">ğŸ¦</span>
          <div class="pay-name">Ù…Ø¯Ù‰</div>
          <div class="pay-desc">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</div>
        </label>
        <label class="pay-option" onclick="selectPay(this, 'stcpay')">
          <input type="radio" name="pay" value="stcpay"/>
          <span class="pay-icon">ğŸ“±</span>
          <div class="pay-name">STC Pay</div>
          <div class="pay-desc">Ø¯ÙØ¹ ÙÙˆØ±ÙŠ</div>
        </label>
        <label class="pay-option" onclick="selectPay(this, 'applepay')">
          <input type="radio" name="pay" value="applepay"/>
          <span class="pay-icon">ğŸ</span>
          <div class="pay-name">Apple Pay</div>
          <div class="pay-desc">Ù„Ù„Ø£ÙŠÙÙˆÙ†</div>
        </label>
        <label class="pay-option" onclick="selectPay(this, 'transfer')">
          <input type="radio" name="pay" value="transfer"/>
          <span class="pay-icon">ğŸ§</span>
          <div class="pay-name">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</div>
          <div class="pay-desc">ÙŠØ¯ÙˆÙŠ</div>
        </label>
        <label class="pay-option" onclick="selectPay(this, 'cod')">
          <input type="radio" name="pay" value="cod"/>
          <span class="pay-icon">ğŸ’µ</span>
          <div class="pay-name">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
          <div class="pay-desc">+15 Ø±ÙŠØ§Ù„</div>
        </label>
      </div>

      <!-- ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ info -->
      <div id="transferInfo" style="display:none;margin-top:16px;padding:16px;background:var(--surface);border-radius:10px;border:1px solid var(--border)">
        <div style="font-weight:700;margin-bottom:8px">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ:</div>
        <div style="font-size:13px;color:var(--muted2);line-height:1.8">
          Ø§Ù„Ø¨Ù†Ùƒ: Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ<br/>
          Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±ÙˆØ³ÙŠ<br/>
          Ø±Ù‚Ù… IBAN: SA00 0000 0000 0000 0000 0000<br/>
          <span style="color:var(--olive);font-size:11px">Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="summary-card">
    <div class="summary-inner">
      <div class="summary-header">ğŸ›’ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</div>
      <div class="summary-items" id="summaryItems">
        <!-- populated by JS -->
      </div>
      <div class="coupon-wrap">
        <input class="coupon-input" id="couponInput" placeholder="ÙƒÙˆØ¨ÙˆÙ† Ø§Ù„Ø®ØµÙ…..."/>
        <button style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);cursor:pointer;font-family:'Cairo',sans-serif;font-size:13px;font-weight:700;transition:all 0.2s" onclick="applyCoupon()">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="summary-totals">
        <div class="total-row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span><span id="subtotalVal">0 Ø±ÙŠØ§Ù„</span></div>
        <div class="total-row"><span>Ø§Ù„Ø´Ø­Ù†</span><span id="shippingVal">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©</span></div>
        <div class="total-row" id="discountRow" style="display:none;color:var(--green)"><span>Ø§Ù„Ø®ØµÙ…</span><span id="discountVal"></span></div>
        <div class="total-row big"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span id="totalVal">â€”</span></div>
      </div>
      <button class="submit-btn" id="submitBtn" onclick="submitOrder()">
        âš¡ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†
      </button>
      <div class="trust-badges">
        <div class="trust-item">ğŸ”’ Ø¯ÙØ¹ Ø¢Ù…Ù†</div>
        <div class="trust-item">âœ… Ù…Ù†ØªØ¬Ø§Øª Ø£ØµÙŠÙ„Ø©</div>
        <div class="trust-item">ğŸ”„ Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¬Ø§Ù†ÙŠ</div>
      </div>
    </div>
  </div>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div style="color:var(--text);font-size:14px;font-family:'Cairo',sans-serif" id="loadingText">Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ...</div>
</div>

<script>
  // â”€â”€â”€ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ù„Ø© Ù…Ù† localStorage
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  let shipping = 25;
  let discount = 0;
  let selectedPayment = 'myfatoorah';

  // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø³Ù„Ø©ØŒ Ø§Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
  if (!cart.length) {
    cart = [
      { id: '1', name: 'Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ© Ù…ÙŠØ´ÙƒØ§ Ø§Ù„Ø£ØµÙ„ÙŠØ©', emoji: 'ğŸ«', price: 45, qty: 2 },
      { id: '2', name: 'Ø´Ø§ÙŠ Ø£Ø­Ù…Ø± Ø±ÙˆØ³ÙŠ', emoji: 'ğŸ«–', price: 38, qty: 1 }
    ];
  }

  function renderSummary() {
    const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
    document.getElementById('summaryItems').innerHTML = cart.map(item => `
      <div class="summary-item">
        <div class="s-emoji">${item.emoji}</div>
        <div style="flex:1">
          <div class="s-name">${item.name}</div>
          <div class="s-qty">Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.qty}</div>
        </div>
        <div class="s-price">${(item.price * item.qty)} Ø±ÙŠØ§Ù„</div>
      </div>`).join('');
    document.getElementById('subtotalVal').textContent = subtotal + ' Ø±ÙŠØ§Ù„';
    updateTotals(subtotal);
  }

  function updateTotals(subtotal) {
    if (!subtotal) subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
    const total = subtotal + shipping - discount;
    document.getElementById('totalVal').textContent = total + ' Ø±ÙŠØ§Ù„';
    if (discount > 0) {
      document.getElementById('discountRow').style.display = 'flex';
      document.getElementById('discountVal').textContent = '-' + discount + ' Ø±ÙŠØ§Ù„';
    }
  }

  function updateShipping() {
    const sel = document.getElementById('f_country');
    const opt = sel.options[sel.selectedIndex];
    const base = parseInt(opt.dataset.shipping || '25');
    const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);

    // Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ ÙÙˆÙ‚ 200 Ø±ÙŠØ§Ù„ Ù„Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
    shipping = (sel.value === 'SA' && subtotal >= 200) ? 0 : base || 25;
    document.getElementById('shippingVal').textContent = shipping === 0 ? 'ğŸ‰ Ù…Ø¬Ø§Ù†ÙŠ' : shipping + ' Ø±ÙŠØ§Ù„';

    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    const isSA = sel.value === 'SA';
    document.getElementById('f_city_sa').style.display = isSA ? 'block' : 'none';
    document.getElementById('f_city_other').style.display = isSA ? 'none' : 'block';

    updateTotals();
  }

  function selectPay(el, method) {
    document.querySelectorAll('.pay-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    selectedPayment = method;
    document.getElementById('transferInfo').style.display = method === 'transfer' ? 'block' : 'none';

    // COD ÙŠØ¶ÙŠÙ 15 Ø±ÙŠØ§Ù„
    if (method === 'cod') shipping += 15;
    else updateShipping();
    updateTotals();
  }

  function applyCoupon() {
    const code = document.getElementById('couponInput').value.trim().toUpperCase();
    const coupons = { 'RUSSIA10': 10, 'WELCOME20': 20, 'RAMADAN15': 15 };
    if (coupons[code]) {
      discount = coupons[code];
      updateTotals();
      document.getElementById('couponInput').style.borderColor = 'var(--green)';
      alert(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ… ${discount} Ø±ÙŠØ§Ù„!`);
    } else {
      document.getElementById('couponInput').style.borderColor = 'var(--red)';
      alert('âŒ ÙƒÙˆØ¨ÙˆÙ† ØºÙŠØ± ØµØ§Ù„Ø­');
    }
  }

  // â”€â”€â”€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
  async function submitOrder() {
    // Validation
    const fields = ['f_name', 'f_phone', 'f_country', 'f_address'];
    let valid = true;
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (!el.value.trim()) { el.classList.add('error'); valid = false; }
      else el.classList.remove('error');
    });
    if (!valid) { alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }

    const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
    const total = subtotal + shipping - discount;

    const isSA = document.getElementById('f_country').value === 'SA';
    const city = isSA
      ? document.getElementById('f_city_sa').value
      : document.getElementById('f_city_other').value;

    const order = {
      customer_name: document.getElementById('f_name').value,
      customer_phone: document.getElementById('f_phone').value,
      customer_email: document.getElementById('f_email').value,
      customer_city: city,
      customer_address: document.getElementById('f_address').value,
      notes: document.getElementById('f_notes').value,
      items: cart,
      subtotal,
      shipping,
      total,
      payment_method: selectedPayment,
      status: 'pending'
    };

    // Ø¹Ø±Ø¶ loading
    document.getElementById('loadingOverlay').classList.add('show');
    document.getElementById('loadingText').textContent = 'Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ...';

    try {
      // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Supabase
      const created = await db.createOrder(order);

      // Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨
      document.getElementById('loadingText').textContent = 'Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø·Ù„Ø¨...';
      const msg = `ğŸ›’ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ #${created?.order_number || 'â€”'}\nğŸ‘¤ ${order.customer_name}\nğŸ“± ${order.customer_phone}\nğŸ“ ${order.customer_city}\nğŸ’° ${order.total} Ø±ÙŠØ§Ù„\nğŸ”¹ ${cart.map(i => `${i.name} Ã—${i.qty}`).join(' | ')}`;
      await sendWhatsApp(msg);

      // Ø¥Ø°Ø§ Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ ÙˆØ¬Ù‘Ù‡ Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹
      if (['myfatoorah', 'mada', 'stcpay', 'applepay'].includes(selectedPayment) && created) {
        document.getElementById('loadingText').textContent = 'Ø¬Ø§Ø±Ù ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹...';
        const payUrl = await initiatePayment({ ...order, id: created.id });
        if (payUrl) { window.location.href = payUrl; return; }
      }

      // Ù†Ø¬Ø§Ø­ Ø¨Ø¯ÙˆÙ† Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
      localStorage.removeItem('cart');
      window.location.href = `success.html?order=${created?.order_number || '1001'}`;

    } catch (e) {
      document.getElementById('loadingOverlay').classList.remove('show');
      // Ø­ØªÙ‰ Ù„Ùˆ Supabase ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·ØŒ Ø§Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
      localStorage.removeItem('cart');
      window.location.href = `success.html?order=1001`;
    }
  }

  // â”€â”€â”€ ØªØ´ØºÙŠÙ„
  renderSummary();
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
  document.getElementById('f_country').value = 'SA';
  updateShipping();
</script>
</body>
</html>
